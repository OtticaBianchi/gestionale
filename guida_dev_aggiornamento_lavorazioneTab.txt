# üõ† Guida Tecnica: Modulo Lavorazioni & Attivit√† (v2.0)

**Ultimo Aggiornamento:** Gennaio 2026
**Ambito:** `dashboard/buste/[id]/_components/tabs/LavorazioneTab.tsx`

---

## 1. Visione Architetturale

Il modulo "Lavorazioni" √® stato rifondato per risolvere il **Semantic Gap** tra la struttura rigida del database (tabella `lavorazioni`) e la realt√† fluida di un centro ottico moderno.

Non si tracciano pi√π solo "montaggi fisici", ma **Attivit√† Generiche**:
*   Laboratorio (Taglio, assemblaggio)
*   Servizi (Training LAC, Pit-Stop)
*   Logistica (Spedizioni a laboratori esterni)
*   Qualit√† (Checklist pre-consegna)

### Design Pattern: "Logic in Frontend, Storage in Notes"
Per evitare migrazioni database complesse e rischiose, abbiamo adottato una strategia ibrida:
1.  **Categorie DB:** La tabella `tipi_montaggio` funge da dizionario delle attivit√†.
2.  **Logica Applicativa:** Il frontend (`LavorazioneTab.tsx`) decide *cosa* mostrare in base al tipo di busta (OCV, LAC, SOLE).
3.  **Dati Strutturati (JSON):** I dati complessi (es. date spedizione corriere) vengono salvati nel campo `note` come JSON stringify, permettendo interattivit√† senza nuove colonne SQL.

---

## 2. Struttura Dati

### Database (`public.lavorazioni`)
| Campo | Tipo | Descrizione |
|-------|------|-------------|
| `id` | UUID | PK |
| `tipo_montaggio_id` | INT | FK su `tipi_montaggio` (es. "Lab. Esterno") |
| `stato` | TEXT | `in_corso`, `completato`, `fallito` |
| `note` | TEXT | **Polimorfico**: contiene testo semplice O JSON strutturato |
| `responsabile_id` | UUID | Chi ha eseguito l'azione (Certificazione Qualit√†) |

### JSON Schema (per Lab. Esterno)
Quando l'attivit√† √® "Lab. Esterno", il campo `note` contiene:
```json
{
  "isExternalLab": true,
  "userNotes": "Note libere dell'utente...",
  "dates": {
    "scheduled_pickup": "2026-01-24", // Data prevista ritiro
    "scheduled_return": "2026-01-30", // Data prevista consegna
    "actual_pickup": "2026-01-25",    // Data effettiva (aggiornabile da UI)
    "actual_return": null             // Data effettiva rientro
  }
}