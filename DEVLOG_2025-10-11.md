# 2025-10-11 – Telegram Bot & Voice Notes Hardening

## Telegram Ingestion Pipeline

- Introduced an explicit allow-list (`telegram_allowed_users`) that binds each `telegram_user_id` to a profile and `can_use_bot` flag; only rows with `can_use_bot = true` may post via the webhook.
- Reworked `/api/telegram/webhook/route.ts` to:
  - Authorize using the allow-list before touching `profiles`.
  - Backfill legacy profiles that already had `telegram_bot_access = true` but no allow-list row.
  - Keep `profiles.telegram_bot_access` and `telegram_user_id` synchronized whenever an allowed request arrives.
  - Remove the incorrect `.catch` chain around the `increment_message_count` RPC and strengthen the manual fallback path.
  - Add structured logging to highlight allow-list hits/backfills.
- Extended `/api/admin/telegram-auth/route.ts` so pressing **Autorizza** now upserts the allow-list entry (labelled with the profile full name) alongside the existing profile update and audit trail.
- Manual steps executed today:
  1. Created a dedicated Auth/profile record for the shop device.
  2. Seeded `telegram_allowed_users` with the shop row (`8374237498` → `Negozio`) and later with the admin’s phone.
  3. Restarted the webhook deployment after each code change to ensure the new guard was active.

## Voice Notes UI Polishing

- Cleared the empty `<track src="">` element to avoid hydration warnings in the audio player.
- Normalized fetch cancellation handling in `dashboard/voice-notes/page.tsx` so all aborts surface as standard `AbortError` instances (no more `"reload"` / `"unmount"` rejections in dev tools).

## Operational Notes

- The hydration warning on `<body cz-shortcut-listen>` was traced to a browser extension; no code change required.
- Sidebar polling remains throttled to 60 s, respecting free-tier rate limits.
- All Supabase mutations ran with the service-role key (`.env.local`), followed by dev-server restarts to pick up new route handlers.
